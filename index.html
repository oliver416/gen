<!DOCTYPE html>

<html>
  <head>
    <style>
      body {
          font: 10px sans-serif;
      }

      .linage {
          fill: none;
          stroke: #000;
      }

      .marriage {
          fill: none;
          stroke: black;
      }

      .man {
          background-color: lightblue;
          border-style: solid;
          border-width: 1px;
          box-sizing: border-box;
      }

      .woman {
          background-color: salmon;
          border-style: solid;
          border-width: 1px;
          box-sizing: border-box;
      }

      .emphasis {
          font-style: italic;
      }

      p {
        padding:0;
        margin:0;
      }

      svg {
        border-style: solid;
        border-width: 1px;
        height: 100%;
        width: 100%;
      }

      .w100 {
        width: 100%;
      }

      .h100 {
        height: 100%;
      }

      .menu {
        position: absolute;
        height: 5%;
        top: 0;
        left: 0;
      }

      .main {
        position: absolute;
        height: 95%;
        left: 0;
        top: 5%;
        cursor: default;
      }

      .hidden {
        visibility: hidden;
      }

      .visible {
        visibility: visible;
      }

      #graph {
        width: 80%;
      }

      #editForm {
        position: absolute;
        left: 80%;
        top: 0;
        width: 20%;
        display: grid;
      }
    </style>
  </head>
  <body>
    <div class="menu w100">
      <input type="file" id="selectFile" value="Open"/>
      <button id="loadTree">Load tree</button>
    </div>

    <div class="main w100">
      <div id="graph" class="h100"></div>

      <div id="editForm" class="visible">
        <label for="name">Name</label>
        <input type="text" id="name" readonly>
  
        <label for="surname">Surname</label>
        <input type="text" id="surname" readonly>

        <label for="patronymic">Patronymic</label>
        <input type="text" id="patronymic" readonly>

        <label for="maidenname">Maidenname</label>
        <input type="text" id="maidenname" readonly>

        <label for="gender">Gender</label> 
        <input type="radio" id="man" name="gender" value="man">
        <label for="man">Male</label>

        <input type="radio" id="woman" name="gender" value="woman">
        <label for="man">Female</label>

        <label for="birthdate">Birthdate</label>
        <input type="text" id="birthdate" readonly>

        <label for="deathdate">Deathdate</label>
        <input type="text" id="deathdate" readonly>

        <label for="birthplace">Birthplace</label>
        <textarea id="birthplace" readonly></textarea>

        <label for="religion">Religion</label>
        <input type="text" id="religion" readonly>

        <label for="nationality">Nationality</label>
        <input type="text" id="nationality" readonly>

        <label for="education">Education</label>
        <textarea id="education" readonly></textarea>

        <label for="occupation">Occupation</label>
        <textarea id="occupation" readonly></textarea>

        <label for="biography">Biography</label>
        <textarea id="biography" readonly></textarea>

        <label for="cemetery">Cemetery</label>
        <textarea id="cemetery" readonly></textarea>
  
        <button id="editButton">Edit</button>
        <button id="addButton" class="hidden">Add</button>
        <button id="exportButton" class="hidden">Export</button>
      </div>
    </div>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-dtree/dist/dTree.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.1.0/uuidv4.min.js"></script>
    <!-- Possible improvement: https://github.com/eligrey/FileSaver.js -->
    
    <script>
      let familyDB = [];
      let baseName;

      document.getElementById('loadTree').addEventListener('click', loadFile);
      document.getElementById('editButton').addEventListener('click', editForm);
      document.getElementById('addButton').addEventListener('click', addPerson);
      document.getElementById('exportButton').addEventListener('click', saveFile);

      loadTree(familyDB);

      function loadTree(tree) {
        document.getElementById('graph').innerHTML = '';

        dTree.init(tree, {
          target: "#graph",
          debug: true,
          height: 800,
          width: 1200,
          callbacks: {
            nodeClick: function(name, extra, id) {
              let form = document.getElementById('editForm');
              
              showElement(form, true);
              clearForm(form);
              fillForm(name, extra);
              blockForm(form, true);
            },
            textRenderer: function(name, extra, textClass) {
              if (extra) {
                if (extra.surname) {
                  name = `${name} ${extra.surname}`;
                }                

                if (extra.maidenname) {
                  name = `${name} (${extra.maidenname})`;
                }

                if (extra.birthdate) {
                  name = `${name} (${extra.birthdate})`;
                }

                if (extra.deathdate) {
                  name = `${name.slice(0, -1)}-${extra.deathdate})`;
                }
              }

              return "<p align='center' class='" + textClass + "'>" + name + "</p>";
            },
            nodeRenderer: function(name, x, y, height, width, extra, id, nodeClass, textClass, textRenderer) {
              let node = '';
              node += '<div ';
              node += 'style="height:100%;width:100%;" ';
              node += 'class="' + nodeClass + '" ';
              node += 'id="node' + id + '">\n';
              node += textRenderer(name, extra, textClass);
              node += '</div>';
              return node;
          }
          }
        });
      }

      function loadFile() {
        if (typeof window.FileReader !== 'function') {
          return;
        }

        let input = document.getElementById('selectFile');
        if (!input || !input.files || !input.files[0]) {
          return;
        }
        else {
          let file = input.files[0]
          let file_reader = new FileReader();
          file_reader.onload = receivedText;
          file_reader.readAsText(file);
          baseName = file.name;
        }
      }

      function arrayToTree(array) {
        function findParentNode(tree, nodeId) {
          for (let node of tree) {
            if (
                nodeId === node['id'] || 
                nodeId === node['spouse'] || 
                nodeId === node
              ) {
              return node;
            }

            let marriages = node['marriages'];
            let children = node['children'];

            if (marriages) {
              return findParentNode(marriages, nodeId);
            }

            if (children && children.includes(nodeId)) {
              return node;
            } else {
              return findParentNode(children, nodeId);
            }
          }
        }

        function addNode(parentNode, node) {
          let nodeId = node['id'];    
          let spouse = parentNode['spouse'];
          let children = parentNode['children'];   
          
          if (spouse === nodeId) {
            parentNode['spouse'] = node;
            return;
          }

          if (children) {
              for (child of children) {
                if (child === nodeId) {
                  parentNode['children'][children.indexOf(child)] = node;
                  return;
                }
              }
            }
        }

        let tree;
        for (let node of array) {
          if (!tree){
            tree = [node];
            continue;
          }

          let nodeId = node['id'];
          
          parentNode = findParentNode(tree, nodeId);
          addNode(parentNode, node);
        }

        return tree;
      }

      function receivedText(e) {
        try {
          let familyDB = JSON.parse(e.target.result);
          let tree = arrayToTree(familyDB);
          loadTree(tree);
        } catch {
          return;
        }
        
      }
      
      function showElement(element, isVisible) {
          element.removeAttribute('class');
          element.classList.add(isVisible ? 'visible': 'hidden');
      }

      function clearForm(form) {
        let nodes = form.querySelectorAll('input, textarea');

        for (let node of nodes) {
          node.value = '';
        }
      }

      function fillForm(name, data) {
        document.getElementById('name').value = name;

        if (data) {
          for (let key in data) {
            document.getElementById(key).value = data[key];
          }
        }
      }

      function editForm() {
        let form = document.getElementById('editForm');
        let addButton = document.getElementById('addButton');
        let editButton = document.getElementById('editButton');
        
        blockForm(form, false);
        showElement(addButton, true);
        showElement(editButton, false);
      }

      function blockForm(form, isBlocked) {
        let nodes = form.querySelectorAll('input, textarea');

        for (let node of nodes) {
          node.readOnly = isBlocked;
        }
      }

      function extractFormData(form) {
        let inputs = form.getElementsByTagName('input');
        let textareas = form.getElementsByTagName('textarea');
      
        let attributes = {}

        for (let input of inputs) {
          if (input.id === 'man' || input.id === 'woman') { 
            if (input.checked) {
              attributes['gender'] = input.value;
            }
            continue;
          }

          attributes[input.id] = input.value;
        }

        for (let textarea of textareas) {
          attributes[textarea.id] = textarea.value;
        }

        return attributes;
      }

      function addPerson() {
        // todo: refactor such variables
        let form = document.getElementById('editForm');
        let addButton = document.getElementById('addButton');
        let editButton = document.getElementById('editButton');
        
        let attributes = extractFormData(form);
        let name = attributes['name'] ? attributes['name'] : 'Unknown';
        let gender = attributes['gender'] ? attributes['gender']: 'man';
        
        let extra = {};

        for (let key in attributes) {
          if (key === 'name' || key === 'gender') {
            continue;
          }

          extra[key] = attributes[key];
        }

        let person = {
          "id": uuidv4(),
          "name": name,
          "class": gender,
          "extra": extra,
        }

        familyDB.push(person);
        let tree = arrayToTree(familyDB);
        loadTree(tree);

        showElement(addButton, false);
        showElement(editButton, true);
      }

      function saveFile() {
        var file = new Blob([JSON.stringify(familyDB)], {type: 'text/json'});
        if (window.navigator.msSaveOrOpenBlob) // IE10+
            window.navigator.msSaveOrOpenBlob(file, baseName);
        else { // Others
            let link = document.createElement('a');
            let url = URL.createObjectURL(file);
            
            link.href = url;
            link.download = baseName;
            document.body.appendChild(link);
            link.click();
            setTimeout(function() {
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);  
            }, 0); 
        }
      }
    </script>
  </body>
</html>